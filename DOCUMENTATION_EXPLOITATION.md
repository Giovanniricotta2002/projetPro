# üìñ Documentation Technique d'Exploitation - MuscuScope

> **Crit√®re C2.4.1** - R√©diger la documentation technique d'exploitation du logiciel d√©taillant son fonctionnement afin d'assurer une tra√ßabilit√© pour le suivi des √©quipes et des futures √©volutions du logiciel.

## üéØ Objectifs de la Documentation

Cette documentation technique fournit toutes les informations n√©cessaires pour exploiter, maintenir et faire √©voluer la plateforme MuscuScope en production. Elle s'adresse aux √©quipes DevOps, SRE et d√©veloppeurs responsables de l'infrastructure et du support technique.

---

## üèóÔ∏è Architecture Technique D√©taill√©e

### Vue d'Ensemble du Syst√®me

```mermaid
flowchart TB
    subgraph "Client Layer"
        Web[Navigateur Web]
        Mobile[Application Mobile]
    end
    
    subgraph "Load Balancer"
        LB[Cloud Load Balancer<br/>Google Cloud Run]
    end
    
    subgraph "Application Layer"
        FE[Frontend Container<br/>Vue.js 3.5 + Nginx<br/>Port 80]
        BE[Backend Container<br/>Symfony 7.3 + Apache<br/>Port 8000]
    end
    
    subgraph "Data Layer"
        DB[(PostgreSQL 14<br/>Cloud SQL)]
        Redis[(Redis Cache<br/>Session Store)]
        Storage[Cloud Storage<br/>File Assets]
    end
    
    subgraph "Monitoring"
        Grafana[Grafana Dashboard]
        Loki[Loki Logs]
        CloudMonitoring[Cloud Monitoring]
    end
    
    Web --> LB
    Mobile --> LB
    LB --> FE
    LB --> BE
    BE --> DB
    BE --> Redis
    BE --> Storage
    FE --> Storage
    
    BE --> Loki
    FE --> Loki
    Grafana --> CloudMonitoring
    Grafana --> Loki
```

### Outils de diagnostic

```bash
# Diagnostic Tools - Scripts op√©rationnels disponibles
./scripts/monitoring/diagnose-health.sh        # Health check complet syst√®me
./scripts/testing/run-smoke-tests.sh           # Tests de fum√©e rapides  
./scripts/testing/load-testing.sh              # Tests de charge K6 + Lighthouse

# Deployment Tools - D√©ploiement et rollback
./scripts/deployment/check-prerequisites.sh    # V√©rification pr√©requis
./scripts/deployment/deploy-production.sh      # D√©ploiement production complet
./scripts/deployment/rollback-production.sh    # Rollback d'urgence

# Maintenance Tools - Maintenance automatis√©e
./scripts/maintenance/weekly-maintenance.sh    # Maintenance hebdomadaire
./scripts/maintenance/backup-production.sh     # Backup complet avec int√©grit√©

# Incident Tools - Gestion d'incidents
./scripts/incident/runbook-p0-app-down.sh     # Proc√©dure urgence P0

# Index et aide compl√®te
./scripts/scripts-index.sh                     # Documentation compl√®te des scripts
```

### Stack Technologique Compl√®te

#### Frontend (Client)
```yaml
Framework: Vue.js 3.5.8
UI Library: Vuetify 3.8.0
Build Tool: Vite 5.4.0
State Management: Pinia 2.1.7
HTTP Client: fetch
Testing: Vitest + Vue Test Utils
Language: TypeScript 5.5.0
```

#### Backend (API)
```yaml
Framework: Symfony 7.3
Language: PHP 8.3
Database ORM: Doctrine 3.2
Authentication: JWT (LexikJWTAuthenticationBundle)
API Documentation: NelmioApiDocBundle (OpenAPI)
Testing: PHPUnit 11 + Behat
Quality: PHPStan (Level 8) + PHP_CodeSniffer
Container: Apache 2.4 + PHP-FPM
```

#### Infrastructure
```yaml
Cloud Provider: Google Cloud Platform
Container Runtime: Cloud Run (Knative)
Database: Cloud SQL PostgreSQL 14
Storage: Cloud Storage (Multi-regional)
Networking: VPC + Cloud Load Balancer
Monitoring: Grafana + Loki + Cloud Monitoring
Logs: Loki (Centralized log aggregation)
CI/CD: GitHub Actions + Docker Hub
IaC: Terraform 1.9.0
```

---

## üöÄ Proc√©dures de D√©ploiement

### Environnements Disponibles

| Environnement | URL | Usage | Auto-scaling |
|---------------|-----|-------|--------------|
| **Development** | `http://localhost:3000` | D√©veloppement local | Docker Compose |
| **Staging** | `https://staging.muscuscope.com` | Tests pr√©-production | 0-2 instances |
| **Production** | `https://muscuscope.com` | Production live | 0-10 instances |

### D√©ploiement Production

#### 1. Pr√©requis de D√©ploiement
```bash
# V√©rifications pr√©alables
echo "üîç V√©rification des pr√©requis de d√©ploiement"

# 1. Authentification GCP
gcloud auth list --filter=status:ACTIVE
if [ $? -ne 0 ]; then
    echo "‚ùå Authentification GCP requise"
    exit 1
fi

# 2. Acc√®s Docker Hub
docker login
if [ $? -ne 0 ]; then
    echo "‚ùå Authentification Docker Hub requise"
    exit 1
fi

# 3. V√©rification Terraform
terraform version
if [ $? -ne 0 ]; then
    echo "‚ùå Terraform requis"
    exit 1
fi

# 4. Tests de validation
./run-smoke-tests.sh
if [ $? -ne 0 ]; then
    echo "‚ùå Tests de validation √©chou√©s"
    exit 1
fi

echo "‚úÖ Tous les pr√©requis sont satisfaits"
```

#### 2. Processus de D√©ploiement Automatis√©
```bash
#!/bin/bash
# deploy-production.sh - Script de d√©ploiement production

set -e

VERSION=${1:-"latest"}
ENVIRONMENT="production"

echo "üöÄ D√©ploiement MuscuScope v$VERSION en production"

# Phase 1: Build et Push des Images
echo "üì¶ Build des images Docker..."
./build-images.sh $VERSION

# Phase 2: D√©ploiement Infrastructure
echo "üèóÔ∏è Mise √† jour infrastructure..."
cd terraform/
terraform plan -var="app_version=$VERSION" -out=production.tfplan
terraform apply production.tfplan

# Phase 3: D√©ploiement Applications
echo "üöÄ D√©ploiement applications..."
./deploy-backend.sh $VERSION
./deploy-frontend.sh $VERSION

# Phase 4: Tests Post-D√©ploiement
echo "üß™ Tests post-d√©ploiement..."
./post-deployment-tests.sh $ENVIRONMENT

# Phase 5: Notification
echo "üì¢ Notification √©quipes..."
./notify-deployment.sh $VERSION $ENVIRONMENT "SUCCESS"

echo "‚úÖ D√©ploiement termin√© avec succ√®s"
```

#### 3. Rollback d'Urgence
```bash
#!/bin/bash
# rollback-production.sh - Proc√©dure de rollback d'urgence

PREVIOUS_VERSION=${1:-"latest-stable"}

echo "üîÑ Rollback d'urgence vers $PREVIOUS_VERSION"

# 1. Rollback Backend (priorit√©)
gcloud run services update backend-api \
    --image="giovanni2002ynov/muscuscope:backend-$PREVIOUS_VERSION" \
    --region=europe-west1

# 2. Rollback Frontend
gcloud run services update frontend \
    --image="giovanni2002ynov/muscuscope:frontend-$PREVIOUS_VERSION" \
    --region=europe-west1

# 3. V√©rification sant√©
sleep 30
curl -f https://muscuscope.com/api/health || exit 1
curl -f https://muscuscope.com/ || exit 1

echo "‚úÖ Rollback termin√© - Services op√©rationnels"
```

---

## üîß Configuration et Variables d'Environnement

### Variables d'Environnement Backend

#### Production
```bash
# Application Core
APP_ENV=prod
APP_DEBUG=0
APP_SECRET=[SECRET_32_CHARS]

# Base de Donn√©es
DATABASE_URL="postgresql://user:pass@host:5432/muscuscope_prod?sslmode=require"
REDIS_URL="redis://redis-cluster:6379/0"

# JWT Authentication
JWT_SECRET_KEY=/var/jwt/private.pem
JWT_PUBLIC_KEY=/var/jwt/public.pem
JWT_PASSPHRASE=[JWT_PASSPHRASE]
JWT_TTL=86400

# CORS Configuration
CORS_ALLOW_ORIGIN="https://muscuscope.com,https://*.muscuscope.com"

# External Services
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USERNAME=[SMTP_USER]
SMTP_PASSWORD=[SMTP_PASS]

# Cloud Storage
GCS_BUCKET_NAME=muscuscope-assets
GCS_PROJECT_ID=muscuscope-prod

# Monitoring
LOG_LEVEL=warning
SENTRY_DSN=[SENTRY_DSN]
```

#### Staging
```bash
# Application Core
APP_ENV=dev
APP_DEBUG=1

# Base de Donn√©es
DATABASE_URL="postgresql://staging_user:pass@staging-db:5432/muscuscope_staging"

# CORS (plus permissif pour tests)
CORS_ALLOW_ORIGIN="*"

# Logs (plus verbeux)
LOG_LEVEL=debug
```

### Variables d'Environnement Frontend

```bash
# API Configuration
VITE_API_URL=https://api.muscuscope.com
VITE_APP_NAME=MuscuScope
VITE_APP_VERSION=1.2.0

# Feature Flags
VITE_ENABLE_ANALYTICS=true
VITE_ENABLE_DEBUG_MODE=false

# External Services
VITE_SENTRY_DSN=[SENTRY_DSN_FRONTEND]
VITE_GOOGLE_ANALYTICS_ID=GA-XXXXX
```

---

## üìä Monitoring et Observabilit√©

### M√©triques Syst√®me

#### Backend API Metrics
```yaml
Health Endpoints:
  - /api/health: Health check g√©n√©ral
  - /api/health/db: Connectivit√© base de donn√©es
  - /api/health/redis: Connectivit√© cache Redis
  - /api/health/storage: Acc√®s Cloud Storage

Key Metrics:
  - Response Time: p50, p95, p99
  - Error Rate: 4xx, 5xx par endpoint
  - Throughput: Requ√™tes par seconde
  - Database Connections: Pool utilization
  - Memory Usage: Heap, non-heap
  - CPU Usage: Pourcentage utilisation
```

#### Frontend Metrics
```yaml
Performance Metrics:
  - Page Load Time: First Contentful Paint
  - Core Web Vitals: LCP, FID, CLS
  - Bundle Size: Total, par chunk
  - API Response Time: C√¥t√© client

User Experience:
  - Error Rate: JavaScript errors
  - Navigation Flow: Funnel analysis
  - Feature Usage: Click tracking
  - Browser Support: Compatibilit√©
```

### Dashboards Grafana

#### Dashboard Production Overview
```json
{
  "dashboard": {
    "title": "MuscuScope Production Overview",
    "panels": [
      {
        "title": "API Response Time",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, http_request_duration_seconds_bucket{service=\"backend-api\"})",
            "legendFormat": "95th percentile"
          }
        ]
      },
      {
        "title": "Error Rate",
        "type": "singlestat",
        "targets": [
          {
            "expr": "rate(http_requests_total{status=~\"5..\"}[5m]) / rate(http_requests_total[5m]) * 100",
            "legendFormat": "Error Rate %"
          }
        ]
      },
      {
        "title": "Active Users",
        "type": "graph",
        "targets": [
          {
            "expr": "sum(increase(user_sessions_total[1h]))",
            "legendFormat": "Hourly Active Users"
          }
        ]
      }
    ]
  }
}
```

### Alertes Critiques

#### Configuration Grafana Alerts

```json
{
  "alerts": [
    {
      "id": 1,
      "title": "Taux d'Erreur √âlev√© API",
      "condition": "B",
      "data": [
        {
          "refId": "A",
          "queryType": "loki",
          "model": {
            "expr": "sum(rate({container=\"muscuscope-backend\"} |= \"ERROR\" [5m]))",
            "interval": "",
            "legendFormat": "Error Rate",
            "refId": "A"
          }
        },
        {
          "refId": "B",
          "queryType": "math",
          "expression": "A > 5",
          "conditions": [
            {
              "query": { "refId": "A" },
              "reducer": { "type": "last" },
              "evaluator": { "params": [5], "type": "gt" }
            }
          ]
        }
      ],
      "frequency": "1m",
      "handler": 1,
      "severity": "critical",
      "message": "Taux d'erreur √©lev√© d√©tect√© dans les logs API (>5 erreurs/min)"
    },
    {
      "id": 2,
      "title": "Base de Donn√©es Indisponible",
      "condition": "B",
      "data": [
        {
          "refId": "A",
          "queryType": "loki",
          "model": {
            "expr": "count_over_time({container=\"muscuscope-backend\"} |= \"database\" |= \"connection\" |= \"failed\" [1m])",
            "interval": "",
            "legendFormat": "DB Connection Errors",
            "refId": "A"
          }
        },
        {
          "refId": "B",
          "queryType": "math",
          "expression": "A > 0",
          "conditions": [
            {
              "query": { "refId": "A" },
              "reducer": { "type": "last" },
              "evaluator": { "params": [0], "type": "gt" }
            }
          ]
        }
      ],
      "frequency": "30s",
      "handler": 1,
      "severity": "critical",
      "message": "Erreurs de connexion base de donn√©es d√©tect√©es dans les logs"
    },
    {
      "id": 3,
      "title": "Temps de R√©ponse √âlev√©",
      "condition": "B",
      "data": [
        {
          "refId": "A",
          "queryType": "cloudmonitoring",
          "model": {
            "metricType": "run.googleapis.com/request_latencies",
            "filters": [
              "resource.label.service_name=\"muscuscope-backend\""
            ],
            "aggregation": {
              "alignmentPeriod": "300s",
              "perSeriesAligner": "ALIGN_PERCENTILE_95",
              "crossSeriesReducer": "REDUCE_MEAN"
            }
          }
        },
        {
          "refId": "B",
          "queryType": "math",
          "expression": "A > 2000",
          "conditions": [
            {
              "query": { "refId": "A" },
              "reducer": { "type": "avg" },
              "evaluator": { "params": [2000], "type": "gt" }
            }
          ]
        }
      ],
      "frequency": "2m",
      "handler": 2,
      "severity": "warning",
      "message": "Temps de r√©ponse P95 d√©passe 2 secondes"
    },
    {
      "id": 4,
      "title": "Utilisation M√©moire √âlev√©e",
      "condition": "B",
      "data": [
        {
          "refId": "A",
          "queryType": "cloudmonitoring",
          "model": {
            "metricType": "run.googleapis.com/container/memory/utilizations",
            "filters": [
              "resource.label.service_name=\"muscuscope-backend\""
            ],
            "aggregation": {
              "alignmentPeriod": "300s",
              "perSeriesAligner": "ALIGN_MEAN",
              "crossSeriesReducer": "REDUCE_MEAN"
            }
          }
        },
        {
          "refId": "B",
          "queryType": "math",
          "expression": "A > 0.85",
          "conditions": [
            {
              "query": { "refId": "A" },
              "reducer": { "type": "avg" },
              "evaluator": { "params": [0.85], "type": "gt" }
            }
          ]
        }
      ],
      "frequency": "2m",
      "handler": 2,
      "severity": "warning",
      "message": "Utilisation m√©moire d√©passe 85%"
    },
    {
      "id": 5,
      "title": "Erreurs 5xx Fr√©quentes",
      "condition": "B",
      "data": [
        {
          "refId": "A",
          "queryType": "loki",
          "model": {
            "expr": "sum(rate({container=\"muscuscope-backend\"} |~ \"HTTP/[0-9\\.]+\\\" 5[0-9]{2}\" [5m]))",
            "interval": "",
            "legendFormat": "5xx Errors Rate",
            "refId": "A"
          }
        },
        {
          "refId": "B",
          "queryType": "math",
          "expression": "A > 0.1",
          "conditions": [
            {
              "query": { "refId": "A" },
              "reducer": { "type": "last" },
              "evaluator": { "params": [0.1], "type": "gt" }
            }
          ]
        }
      ],
      "frequency": "1m",
      "handler": 1,
      "severity": "critical",
      "message": "Taux d'erreurs 5xx √©lev√© (>0.1/sec)"
    }
  ],
  "notificationChannels": [
    {
      "id": 1,
      "name": "Slack Critical",
      "type": "slack",
      "settings": {
        "url": "https://hooks.slack.com/services/xxx/xxx/xxx",
        "channel": "#production-alerts",
        "title": "üö® ALERTE CRITIQUE MuscuScope",
        "text": "{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}"
      }
    },
    {
      "id": 2,
      "name": "Email Tech Team",
      "type": "email",
      "settings": {
        "addresses": "tech-team@muscuscope.com",
        "subject": "‚ö†Ô∏è Alerte MuscuScope - {{ .GroupLabels.alertname }}"
      }
    }
  ]
}
```

---

## üîí S√©curit√© et Acc√®s

### Configuration de S√©curit√©

#### Nginx Security Headers
```nginx
# Security headers
add_header X-Content-Type-Options "nosniff" always;
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; connect-src 'self' https://api.muscuscope.com" always;

# HSTS (HTTP Strict Transport Security)
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
```

#### Symfony Security Configuration
```yaml
# config/packages/security.yaml
security:
    password_hashers:
        App\Entity\User:
            algorithm: auto
            cost: 12

    providers:
        app_user_provider:
            entity:
                class: App\Entity\User
                property: email

    firewalls:
        dev:
            pattern: ^/(_(profiler|wdt)|css|images|js)/
            security: false

        api_login:
            pattern: ^/api/login
            stateless: true
            json_login:
                check_path: /api/login
                success_handler: lexik_jwt_authentication.handler.authentication_success
                failure_handler: lexik_jwt_authentication.handler.authentication_failure

        api:
            pattern: ^/api
            stateless: true
            jwt: ~

    access_control:
        - { path: ^/api/login, roles: PUBLIC_ACCESS }
        - { path: ^/api/csrf-token, roles: PUBLIC_ACCESS }
        - { path: ^/api/health, roles: PUBLIC_ACCESS }
        - { path: ^/api/doc, roles: PUBLIC_ACCESS }
        - { path: ^/api, roles: IS_AUTHENTICATED_FULLY }
```

### Gestion des Acc√®s

#### Matrice des Permissions
| R√¥le | API Access | Admin Panel | Moderation | Metrics |
|------|------------|-------------|------------|---------|
| **GUEST** | Lecture limit√©e | ‚ùå | ‚ùå | ‚ùå |
| **USER** | CRUD personnel | ‚ùå | ‚ùå | ‚ùå |
| **MODERATOR** | CRUD + mod√©ration | Limit√© | ‚úÖ | Limit√© |
| **ADMIN** | Full access | ‚úÖ | ‚úÖ | ‚úÖ |
| **SUPER_ADMIN** | System access | ‚úÖ | ‚úÖ | ‚úÖ |

#### Proc√©dure d'Acc√®s Urgence
```bash
# Acc√®s d'urgence pour support technique
# 1. Connexion via bastion host
gcloud compute ssh bastion-host --zone=europe-west1-b

# 2. Acc√®s base de donn√©es (lecture seule)
psql "postgresql://readonly_user:pass@db-host:5432/muscuscope_prod"

# 3. Consultation logs application
gcloud logging read "resource.type=cloud_run_revision AND severity>=WARNING" --limit=100

# 4. Acc√®s container pour debug (urgence uniquement)
gcloud run services proxy backend-api --port=8080 --region=europe-west1
```

---

## üõ†Ô∏è Maintenance et Op√©rations

### Proc√©dures de Maintenance R√©guli√®re

#### Maintenance Hebdomadaire
```bash
#!/bin/bash
# weekly-maintenance.sh - Maintenance hebdomadaire automatis√©e

echo "üîß D√©but maintenance hebdomadaire $(date)"

# 1. Nettoyage logs anciens (>30 jours)
gcloud logging read "timestamp < \"$(date -d '30 days ago' -Iseconds)\"" --format="value(logName)" | head -1000 | \
while read log_name; do
    gcloud logging logs delete "$log_name" --quiet
done

# 2. Analyse s√©curit√© des d√©pendances
cd /app/backend && composer audit
cd /app/frontend && npm audit

# 3. Backup base de donn√©es
gcloud sql export sql muscuscope-db-prod gs://muscuscope-backups/weekly/backup-$(date +%Y%m%d).sql

# 4. Nettoyage storage temporaire
gsutil -m rm -r gs://muscuscope-temp/uploads/$(date -d '7 days ago' +%Y%m%d)*

# 5. V√©rification int√©grit√© base de donn√©es
psql $DATABASE_URL -c "VACUUM ANALYZE;"

# 6. G√©n√©ration rapport sant√©
./generate-health-report.sh > /tmp/health-report-$(date +%Y%m%d).txt

echo "‚úÖ Maintenance hebdomadaire termin√©e"
```

#### Maintenance Mensuelle
```bash
#!/bin/bash
# monthly-maintenance.sh - Maintenance mensuelle

echo "üîß D√©but maintenance mensuelle $(date)"

# 1. Mise √† jour s√©curit√© OS (staging d'abord)
gcloud compute instances list --filter="name~staging" --format="value(name)" | \
while read instance; do
    gcloud compute ssh $instance --command="sudo apt update && sudo apt upgrade -y"
done

# 2. Rotation certificats SSL
gcloud compute ssl-certificates list --format="value(name,managed.domains[0])" | \
while read cert domain; do
    expiry=$(gcloud compute ssl-certificates describe $cert --format="value(managed.expiry)")
    # V√©rifier expiration dans les 30 jours et renouveler si n√©cessaire
done

# 3. Audit complet s√©curit√©
./security-audit.sh --full-scan

# 4. Performance tuning database
psql $DATABASE_URL -c "REINDEX DATABASE muscuscope_prod;"
psql $DATABASE_URL -c "ANALYZE;"

# 5. Mise √† jour documentation
./update-runbooks.sh

echo "‚úÖ Maintenance mensuelle termin√©e"
```

### Proc√©dures de Backup et Restore

#### Backup Automatis√©
```bash
#!/bin/bash
# backup-production.sh - Backup complet production

BACKUP_DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_BUCKET="gs://muscuscope-backups"

echo "üíæ D√©but backup production $BACKUP_DATE"

# 1. Backup base de donn√©es
echo "üìä Backup base de donn√©es..."
gcloud sql export sql muscuscope-db-prod \
    $BACKUP_BUCKET/database/muscuscope-db-$BACKUP_DATE.sql \
    --database=muscuscope_prod

# 2. Backup fichiers utilisateurs
echo "üìÅ Backup fichiers utilisateurs..."
gsutil -m cp -r gs://muscuscope-assets/uploads \
    $BACKUP_BUCKET/assets/uploads-$BACKUP_DATE/

# 3. Backup configuration
echo "‚öôÔ∏è Backup configuration..."
kubectl get configmaps -o yaml > /tmp/configmaps-$BACKUP_DATE.yaml
gsutil cp /tmp/configmaps-$BACKUP_DATE.yaml $BACKUP_BUCKET/config/

# 4. Verification int√©grit√©
echo "üîç V√©rification int√©grit√© backup..."
gsutil du -sh $BACKUP_BUCKET/database/muscuscope-db-$BACKUP_DATE.sql
gsutil du -sh $BACKUP_BUCKET/assets/uploads-$BACKUP_DATE/

# 5. R√©tention (garde 30 jours)
gsutil -m rm $BACKUP_BUCKET/database/muscuscope-db-$(date -d '30 days ago' +%Y%m%d)_*.sql
gsutil -m rm -r $BACKUP_BUCKET/assets/uploads-$(date -d '30 days ago' +%Y%m%d)_*/

echo "‚úÖ Backup termin√©: $BACKUP_DATE"
```

#### Proc√©dure de Restore
```bash
#!/bin/bash
# restore-production.sh - Proc√©dure de restauration

BACKUP_FILE=${1:-"latest"}
TARGET_ENV=${2:-"staging"}

if [ "$TARGET_ENV" = "production" ]; then
    echo "‚ö†Ô∏è ATTENTION: Restauration en PRODUCTION"
    echo "Tapez 'CONFIRM' pour continuer:"
    read confirmation
    if [ "$confirmation" != "CONFIRM" ]; then
        echo "‚ùå Restauration annul√©e"
        exit 1
    fi
fi

echo "üîÑ D√©but restauration sur $TARGET_ENV"

# 1. Arr√™t applications (sauf prod)
if [ "$TARGET_ENV" != "production" ]; then
    gcloud run services update backend-api-$TARGET_ENV --min-instances=0 --max-instances=0
    gcloud run services update frontend-$TARGET_ENV --min-instances=0 --max-instances=0
fi

# 2. Restauration base de donn√©es
echo "üìä Restauration base de donn√©es..."
gcloud sql import sql muscuscope-db-$TARGET_ENV \
    gs://muscuscope-backups/database/$BACKUP_FILE

# 3. Restauration fichiers
echo "üìÅ Restauration fichiers..."
gsutil -m rsync -r -d gs://muscuscope-backups/assets/$BACKUP_FILE/ \
    gs://muscuscope-assets-$TARGET_ENV/

# 4. Red√©marrage applications
if [ "$TARGET_ENV" != "production" ]; then
    gcloud run services update backend-api-$TARGET_ENV --min-instances=1 --max-instances=3
    gcloud run services update frontend-$TARGET_ENV --min-instances=1 --max-instances=3
fi

# 5. Tests post-restore
./post-restore-tests.sh $TARGET_ENV

echo "‚úÖ Restauration termin√©e sur $TARGET_ENV"
```

---

## üö® Proc√©dures d'Incident

### Classification des Incidents

| Severity | D√©finition | Exemple | Response Time |
|----------|------------|---------|---------------|
| **P0 - Critical** | Service compl√®tement indisponible | Site down, DB corrompue | **15 minutes** |
| **P1 - High** | Fonctionnalit√© core indisponible | Login impossible, API errors | **1 heure** |
| **P2 - Medium** | D√©gradation de service | Performance lente, erreurs sporadiques | **4 heures** |
| **P3 - Low** | Probl√®me mineur | UI glitch, logs erreurs | **1 jour** |

### Proc√©dure d'Escalade

```mermaid
flowchart TD
    Detect[üîç D√©tection Incident]
    
    Detect --> Assess{üìä √âvaluation Severity}
    
    Assess -->|P0| P0Flow[üö® Alerte Imm√©diate<br/>- SMS Astreinte<br/>- Slack #emergency<br/>- Email Management]
    Assess -->|P1| P1Flow[‚ö° Alerte Rapide<br/>- Slack #incidents<br/>- Email Team<br/>- Escalade si >1h]
    Assess -->|P2/P3| P23Flow[üì¢ Notification Standard<br/>- Ticket Creation<br/>- Assignment]
    
    P0Flow --> Resolve[üîß R√©solution]
    P1Flow --> Resolve
    P23Flow --> Resolve
    
    Resolve --> PostMortem[üìã Post-Mortem]
    PostMortem --> Improve[üîÑ Am√©lioration]
```

### Runbook Incident P0

#### Application Compl√®tement Down
```bash
#!/bin/bash
# runbook-p0-app-down.sh - Incident critique application down

echo "üö® INCIDENT P0: Application Down - $(date)"

# 1. V√©rification rapide infrastructure
echo "üîç V√©rification infrastructure..."
gcloud run services list --filter="service~muscuscope" --format="table(metadata.name,status.conditions.type,status.conditions.status)"

# 2. Check base de donn√©es
echo "üîç V√©rification base de donn√©es..."
gcloud sql instances describe muscuscope-db-prod --format="value(state)"

# 3. Rollback imm√©diat si d√©ploiement r√©cent
LAST_DEPLOY=$(gcloud run revisions list --service=backend-api --limit=2 --format="value(metadata.creationTimestamp)" | head -1)
if [[ $(date -d "$LAST_DEPLOY" +%s) -gt $(date -d "1 hour ago" +%s) ]]; then
    echo "üîÑ Rollback d√©ploiement r√©cent..."
    gcloud run services update backend-api --to-revisions=PREVIOUS
    gcloud run services update frontend --to-revisions=PREVIOUS
fi

# 4. Activation mode d√©grad√© si n√©cessaire
echo "‚ö†Ô∏è Activation page maintenance..."
gsutil cp gs://muscuscope-emergency/maintenance.html gs://muscuscope-assets/index.html

# 5. Notification √©quipes
echo "üì¢ Notification √©quipes..."
./notify-incident.sh "P0" "Application Down" "Investigating..."

echo "‚úÖ Premi√®res mesures ex√©cut√©es"
echo "üëâ Continuer investigation manuelle"
```

### Communication d'Incident

#### Template Status Page
```markdown
## üö® Incident en Cours - Service D√©grad√©

**Status**: INVESTIGATING  
**D√©but**: 2025-07-20 14:30 UTC  
**Derni√®re M√†J**: 2025-07-20 14:45 UTC  

### R√©sum√©
Nous enqu√™tons actuellement sur des difficult√©s d'acc√®s √† la plateforme MuscuScope. Certains utilisateurs peuvent rencontrer des lenteurs ou des erreurs de connexion.

### Impact
- ‚úÖ Consultation des machines: Fonctionnel
- ‚ö†Ô∏è Connexion utilisateur: D√©grad√©  
- ‚ùå Forum communautaire: Indisponible

### Actions en Cours
- Investigation des logs serveur
- V√©rification de la connectivit√© base de donn√©es
- √âquipe technique mobilis√©e

### Prochaine Mise √† Jour
Dans 15 minutes (15:00 UTC)

---
**Status**: IDENTIFIED  
**M√†J**: 2025-07-20 15:00 UTC  

### Cause Identifi√©e
Probl√®me de connectivit√© entre l'API et la base de donn√©es suite √† une mise √† jour de configuration r√©seau.

### Actions Correctives
- Rollback configuration r√©seau en cours
- ETA r√©solution: 15:30 UTC

---
**Status**: RESOLVED  
**M√†J**: 2025-07-20 15:25 UTC  

### R√©solution
Le probl√®me de connectivit√© a √©t√© r√©solu. Tous les services sont maintenant op√©rationnels.

### Post-Mortem
Un rapport d√©taill√© sera publi√© dans les 24h pour expliquer la cause racine et les mesures pr√©ventives mises en place.
```

---

## üìà Performance et Optimisation

### Benchmarks Performance

#### M√©triques Cibles
```yaml
Frontend Performance:
  First Contentful Paint: < 1.5s
  Largest Contentful Paint: < 2.5s
  Cumulative Layout Shift: < 0.1
  Time to Interactive: < 3.5s
  Bundle Size: < 500KB (gzipped)

Backend Performance:
  API Response Time:
    - p50: < 200ms
    - p95: < 500ms
    - p99: < 1000ms
  Database Query Time: < 100ms average
  Memory Usage: < 512MB per instance
  CPU Usage: < 70% under normal load

Database Performance:
  Connection Pool: 20 connections max
  Query Performance: 95% queries < 100ms
  Index Usage: > 95% queries use indexes
  Lock Waits: < 1% of transactions
```

#### Tests de Charge

```bash
#!/bin/bash
# load-testing.sh - Tests de charge automatis√©s

echo "üöÄ D√©but tests de charge MuscuScope"

# Configuration
API_URL="https://api.muscuscope.com"
FRONTEND_URL="https://muscuscope.com"
CONCURRENT_USERS=100
TEST_DURATION="5m"

# 1. Test API Endpoints
echo "üìä Test charge API endpoints..."
k6 run --vus $CONCURRENT_USERS --duration $TEST_DURATION - <<EOF
import http from 'k6/http';
import { check, sleep } from 'k6';

export default function () {
  // Test endpoint authentification
  let authResponse = http.post('$API_URL/api/login', {
    email: 'loadtest@example.com',
    password: 'TestPassword123!'
  });
  
  check(authResponse, {
    'auth response status is 200': (r) => r.status === 200,
    'auth response time < 500ms': (r) => r.timings.duration < 500,
  });
  
  // Test endpoint machines
  let token = authResponse.json('token');
  let machinesResponse = http.get('$API_URL/api/machines', {
    headers: { Authorization: 'Bearer ' + token }
  });
  
  check(machinesResponse, {
    'machines response status is 200': (r) => r.status === 200,
    'machines response time < 200ms': (r) => r.timings.duration < 200,
  });
  
  sleep(1);
}
EOF

# 2. Test Frontend Performance
echo "üé® Test performance frontend..."
lighthouse $FRONTEND_URL --chrome-flags="--headless" --output=json --output-path=/tmp/lighthouse-report.json
PERF_SCORE=$(cat /tmp/lighthouse-report.json | jq '.categories.performance.score * 100')
echo "Performance Score: $PERF_SCORE/100"

# 3. Test Stress Database
echo "üíæ Test stress base de donn√©es..."
pgbench -h $DB_HOST -U $DB_USER -d muscuscope_prod -c 10 -j 2 -t 1000

echo "‚úÖ Tests de charge termin√©s"
```

### Optimisations Automatiques

#### Cache Strategy
```yaml
Frontend Caching:
  Static Assets: 1 year (immutable)
  API Responses: 5 minutes (stale-while-revalidate)
  Images: 6 months (versioned)
  HTML: No cache (always fresh)

Backend Caching:
  Database Queries: Redis 15 minutes
  JWT Tokens: Memory cache 1 hour
  API Responses: HTTP cache 5 minutes
  File Uploads: CDN permanent

Database Optimizations:
  Query Plan Cache: Enabled
  Connection Pooling: PgBouncer
  Read Replicas: 2 instances (read-only)
  Vacuum Schedule: Daily 2AM UTC
```

---

## üìû Contacts et Support

### √âquipe Support Technique

| R√¥le | Contact | Disponibilit√© | Escalade |
|------|---------|---------------|----------|
| **DevOps On-Call** | +33 6 XX XX XX XX | 24/7 | Incidents P0/P1 |
| **Tech Lead** | giovanni.ricotta@muscuscope.com | Lun-Ven 9h-18h | Architecture |
| **DBA** | dba@muscuscope.com | Lun-Ven 8h-20h | Base de donn√©es |
| **Security** | security@muscuscope.com | Lun-Ven 9h-17h | S√©curit√© |
| **Product Owner** | po@muscuscope.com | Lun-Ven 9h-18h | Fonctionnel |

### Canaux de Communication

```yaml
Slack Channels:
  - #production-alerts: Alertes automatiques
  - #incidents: Coordination incidents
  - #deployments: Notifications d√©ploiements
  - #monitoring: M√©triques et dashboards
  - #security: Alertes s√©curit√©

Email Lists:
  - tech-team@muscuscope.com: √âquipe technique
  - on-call@muscuscope.com: Astreinte 24/7
  - management@muscuscope.com: Direction

Emergency Contacts:
  - Hotline Support: +33 1 XX XX XX XX
  - Emergency Slack: #emergency-only
  - SMS Alerts: Configur√© via PagerDuty
```

---

## üìö Ressources et Documentation

### Documentation Technique

| Document | Localisation | Mise √† Jour |
|----------|--------------|-------------|
| **Architecture C4** | `./cloud/README_C4_ARCHITECTURE.md` | Mensuelle |
| **API Documentation** | `https://api.muscuscope.com/doc` | Automatique |
| **Runbooks** | `./docs/runbooks/` | √Ä chaque incident |
| **Security Policies** | `./docs/security/` | Trimestrielle |
| **Change Log** | `./CHANGELOG.md` | √Ä chaque release |

### Outils de Diagnostic

```bash
# Diagnostic Tools
./scripts/diagnose-health.sh        # Health check complet
./scripts/diagnose-performance.sh   # Analyse performance
./scripts/diagnose-security.sh      # Audit s√©curit√©
./scripts/diagnose-database.sh      # Sant√© base de donn√©es

# Monitoring Tools
./scripts/monitor-metrics.sh        # Collecte m√©triques
./scripts/monitor-logs.sh           # Analyse logs
./scripts/monitor-alerts.sh         # √âtat des alertes

# Maintenance Tools
./scripts/maintenance-weekly.sh     # Maintenance hebdomadaire
./scripts/maintenance-monthly.sh    # Maintenance mensuelle
./scripts/backup-production.sh      # Backup complet
./scripts/restore-production.sh     # Restauration
```

### Formation et Onboarding

#### Checklist Nouvel Op√©rateur
- [ ] Acc√®s aux environnements (dev/staging/prod)
- [ ] Configuration outils (kubectl, gcloud, docker)
- [ ] Formation architecture syst√®me
- [ ] Lecture documentation technique compl√®te
- [ ] Simulation proc√©dures d'incident
- [ ] Shadow √©quipe pendant 1 semaine
- [ ] Validation comp√©tences par test pratique

---

**üìñ Cette documentation d'exploitation garantit une maintenance efficace et une √©volution ma√Ætris√©e de MuscuScope en production.**
