name: ğŸš¨ Hotfix Pipeline - Correction Critique
on:
  push:
    branches: [hotfix/*]
  pull_request:
    branches: [hotfix/*]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  tests-rapides:
    name: ğŸ§ª Tests Critiques Express
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ˜ Setup PHP 8.3
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, xml, ctype, iconv, intl, pdo, pdo_mysql, dom, filter, gd, json, pgsql, pdo_pgsql
          coverage: none

      - name: ğŸ“¦ Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: back/vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-php-

      - name: ğŸ”§ Install Composer dependencies
        run: |
          cd back
          composer install --prefer-dist --no-progress --no-suggest --optimize-autoloader

      - name: ğŸ§ª Run Critical Tests Only
        run: |
          cd back
          ./bin/phpunit --group=critical --stop-on-failure --no-coverage
          
      - name: ğŸ” Static Analysis (PHPStan)
        run: |
          cd back
          ./vendor/bin/phpstan analyse --no-progress --error-format=github

      - name: ğŸ“Š Code Style Check
        run: |
          cd back
          ./vendor/bin/phpcs --standard=phpcs.xml.dist --report=checkstyle | cs2pr

  frontend-tests:
    name: ğŸ¨ Tests Frontend Express
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: front/package-lock.json

      - name: ğŸ“¦ Install dependencies
        run: |
          cd front
          npm ci

      - name: ğŸ§ª Run Unit Tests
        run: |
          cd front
          npm run test:unit -- --run

      - name: ğŸ—ï¸ Build Check
        run: |
          cd front
          npm run build

  build-images:
    name: ğŸ³ Build Docker Images
    runs-on: ubuntu-latest
    needs: [tests-rapides, frontend-tests]
    outputs:
      backend-image: ${{ steps.meta-backend.outputs.tags }}
      frontend-image: ${{ steps.meta-frontend.outputs.tags }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ·ï¸ Extract metadata (Backend)
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-

      - name: ğŸ·ï¸ Extract metadata (Frontend)
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-

      - name: ğŸ³ Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: ./back
          file: ./back/Dockerfile
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}

      - name: ğŸ³ Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./front
          file: ./front/Dockerfile
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}

  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-images
    environment: staging
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜ï¸ Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: ğŸ”§ Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: ğŸš€ Deploy to Cloud Run (Backend)
        run: |
          gcloud run deploy muscuscope-backend-staging \
            --image=${{ needs.build-images.outputs.backend-image }} \
            --platform=managed \
            --region=europe-west1 \
            --allow-unauthenticated \
            --set-env-vars="APP_ENV=staging" \
            --memory=512Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=2

      - name: ğŸš€ Deploy to Cloud Run (Frontend)
        run: |
          gcloud run deploy muscuscope-frontend-staging \
            --image=${{ needs.build-images.outputs.frontend-image }} \
            --platform=managed \
            --region=europe-west1 \
            --allow-unauthenticated \
            --memory=256Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=2

  smoke-tests:
    name: ğŸ’¨ Tests Smoke Staging
    runs-on: ubuntu-latest
    needs: deploy-staging
    timeout-minutes: 3
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Health Check Backend
        run: |
          echo "ğŸ” VÃ©rification santÃ© API..."
          curl -f https://muscuscope-backend-staging-xxxxx.a.run.app/api/health || exit 1
          echo "âœ… API accessible"

      - name: ğŸ” Health Check Frontend
        run: |
          echo "ğŸ” VÃ©rification santÃ© Frontend..."
          curl -f https://muscuscope-frontend-staging-xxxxx.a.run.app/ || exit 1
          echo "âœ… Frontend accessible"

      - name: ğŸ§ª API Smoke Tests
        run: |
          echo "ğŸ§ª Tests API critiques..."
          # Test authentification
          curl -X POST https://muscuscope-backend-staging-xxxxx.a.run.app/api/auth/login \
            -H "Content-Type: application/json" \
            -d '{"email":"test@test.com","password":"password"}' || exit 1
          echo "âœ… Authentification fonctionnelle"

  deploy-production:
    name: ğŸ­ Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-images, smoke-tests]
    environment: production
    if: github.ref_name == 'hotfix/critical' && github.event_name == 'push'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜ï¸ Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: ğŸ”§ Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: ğŸš€ Deploy to Cloud Run (Backend) - Blue/Green
        run: |
          # DÃ©ploiement avec rÃ©vision spÃ©cifique
          gcloud run deploy muscuscope-backend \
            --image=${{ needs.build-images.outputs.backend-image }} \
            --platform=managed \
            --region=europe-west1 \
            --allow-unauthenticated \
            --set-env-vars="APP_ENV=production" \
            --memory=1Gi \
            --cpu=2 \
            --min-instances=1 \
            --max-instances=10 \
            --no-traffic
          
          # RÃ©cupÃ©ration de la nouvelle rÃ©vision
          NEW_REVISION=$(gcloud run revisions list --service=muscuscope-backend --region=europe-west1 --limit=1 --format="value(name)")
          
          # Migration progressive du trafic (10% puis 100%)
          gcloud run services update-traffic muscuscope-backend \
            --region=europe-west1 \
            --to-revisions=$NEW_REVISION=10
          
          echo "âœ… 10% du trafic routÃ© vers la nouvelle version"
          sleep 30
          
          # Validation rapide
          curl -f https://muscuscope-backend-xxxxx.a.run.app/api/health || exit 1
          
          # Basculement complet
          gcloud run services update-traffic muscuscope-backend \
            --region=europe-west1 \
            --to-revisions=$NEW_REVISION=100
          
          echo "âœ… 100% du trafic routÃ© - DÃ©ploiement terminÃ©"

      - name: ğŸš€ Deploy to Cloud Run (Frontend)
        run: |
          gcloud run deploy muscuscope-frontend \
            --image=${{ needs.build-images.outputs.frontend-image }} \
            --platform=managed \
            --region=europe-west1 \
            --allow-unauthenticated \
            --memory=512Mi \
            --cpu=1 \
            --min-instances=1 \
            --max-instances=5

  monitoring-post-deploy:
    name: ğŸ“Š Monitoring Post-DÃ©ploiement
    runs-on: ubuntu-latest
    needs: deploy-production
    timeout-minutes: 10
    if: github.ref_name == 'hotfix/critical' && github.event_name == 'push'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“Š Monitoring Health - 5 minutes
        run: |
          echo "ğŸ“Š Surveillance post-dÃ©ploiement pendant 5 minutes..."
          
          for i in {1..10}; do
            echo "ğŸ” Check $i/10..."
            
            # Health check API
            if ! curl -f https://muscuscope-backend-xxxxx.a.run.app/api/health; then
              echo "âŒ API Health check failed"
              exit 1
            fi
            
            # Health check Frontend
            if ! curl -f https://muscuscope-frontend-xxxxx.a.run.app/; then
              echo "âŒ Frontend Health check failed"  
              exit 1
            fi
            
            # VÃ©rification mÃ©triques critiques (exemple)
            echo "âœ… Check $i/10 rÃ©ussi"
            sleep 30
          done
          
          echo "âœ… Monitoring post-dÃ©ploiement terminÃ© avec succÃ¨s"

      - name: ğŸ“± Notification Slack Success
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: success
          text: |
            ğŸš€ **Hotfix DÃ©ployÃ© avec SuccÃ¨s** 
            ğŸ“¦ Branche: ${{ github.ref_name }}
            ğŸ‘¤ Par: ${{ github.actor }}
            ğŸ”— Commit: ${{ github.sha }}
            âœ… Monitoring: OK pendant 5 minutes
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

  rollback-on-failure:
    name: â†©ï¸ Rollback Automatique
    runs-on: ubuntu-latest
    needs: [deploy-production, monitoring-post-deploy]
    if: failure() && github.ref_name == 'hotfix/critical'
    steps:
      - name: â˜ï¸ Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: ğŸ”§ Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: â†©ï¸ Rollback Backend
        run: |
          echo "ğŸš¨ Rollback du backend..."
          gcloud run services update-traffic muscuscope-backend \
            --region=europe-west1 \
            --to-revisions=PREVIOUS=100
          echo "âœ… Backend rollback terminÃ©"

      - name: â†©ï¸ Rollback Frontend
        run: |
          echo "ğŸš¨ Rollback du frontend..."
          # RÃ©cupÃ©ration de la rÃ©vision prÃ©cÃ©dente
          PREVIOUS_REVISION=$(gcloud run revisions list --service=muscuscope-frontend --region=europe-west1 --limit=2 --format="value(name)" | tail -n 1)
          gcloud run services update-traffic muscuscope-frontend \
            --region=europe-west1 \
            --to-revisions=$PREVIOUS_REVISION=100
          echo "âœ… Frontend rollback terminÃ©"

      - name: ğŸ“± Notification Slack Failure
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          text: |
            ğŸš¨ **ROLLBACK AUTOMATIQUE EFFECTUÃ‰**
            ğŸ’¥ Ã‰chec du dÃ©ploiement hotfix
            ğŸ“¦ Branche: ${{ github.ref_name }}
            ğŸ‘¤ Par: ${{ github.actor }}
            ğŸ”„ Rollback: TerminÃ©
            ğŸ“ Action requise: Investigation immÃ©diate
          webhook_url: ${{ secrets.SLACK_WEBHOOK_CRITICAL }}

  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: build-images
    steps:
      - name: ğŸ” Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ needs.build-images.outputs.backend-image }}
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: ğŸ“Š Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
